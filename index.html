<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b132b" />
  <title>IsiVolt Pro V1 ¬∑ Legionella</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="bg-blob blob-a"></div>
  <div class="bg-blob blob-b"></div>
  <div class="bg-sheen"></div>

  <header class="topbar glass">
    <div class="brand">
      <div class="logo">‚ö°</div>
      <div>
        <div class="title">IsiVolt Pro V1</div>
        <div class="subtitle">Legionella Control (PWA)</div>
      </div>
    </div>
    <div class="row">
      <button id="btnGuide" class="btn btn-ghost" title="Gu√≠a r√°pida">üéß</button>
      <button id="btnSettings" class="btn btn-ghost" title="Ajustes">‚öôÔ∏è</button>
    </div>
  </header>

  <main class="container">
    <!-- LOGIN V2.1 -->
    <section id="screenLogin" class="screen hidden">
      <div class="card glass" style="max-width:420px;margin:60px auto 0;">
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:48px;margin-bottom:8px;">&#x26A1;</div>
          <h1 style="margin:0;">IsiVolt Pro</h1>
          <p class="muted tiny" style="margin-top:6px;">Legionella Control &middot; V2.1</p>
        </div>
        <div class="divider"></div>
        <label class="label">Usuario</label>
        <input id="loginUser" class="input" placeholder="Usuario" autocomplete="username" value="paco" />
        <label class="label" style="margin-top:12px;">Contrase&ntilde;a</label>
        <input id="loginPass" class="input" type="password" placeholder="Contrase&ntilde;a" autocomplete="current-password" />
        <button id="btnLogin" class="btn btn-primary" style="width:100%;margin-top:18px;padding:14px;">&#x1F510; Entrar</button>
        <p class="muted tiny" style="margin-top:12px;text-align:center;">Acceso protegido &middot; Cambia la contrase&ntilde;a desde Ajustes</p>
      </div>
    </section>

    <!-- Perfil -->
    <section id="screenProfile" class="screen hidden">
      <div class="card glass">
        <h1>Selecciona T√©cnico</h1>
        <p class="muted">V1.3 guarda datos en este m√≥vil (modo bloc de notas). Puedes cambiar de t√©cnico cuando quieras.</p>
        <div class="row">
          <input id="techName" class="input" placeholder="Nombre t√©cnico (ej: Paco)" maxlength="18" />
          <button id="btnSetTech" class="btn">Entrar</button>
        </div>
        <div class="divider"></div>
        <p class="muted tiny">Consejo: usa el mismo nombre siempre en el mismo m√≥vil para mantener historial limpio.</p>
      </div>
    </section>

    <!-- Home -->
    <section id="screenHome" class="screen hidden">
      <div class="grid">
        <div class="card glass">
          <div class="kpi">
            <div>
              <div class="muted">T√©cnico</div>
              <div id="kpiTech" class="kpi-value">‚Äî</div>
            </div>
            <div class="row">
              <button id="btnSwitchTech" class="btn btn-ghost">Cambiar</button>
              <button id="btnLogout" class="btn btn-danger" title="Cerrar sesi√≥n">Cerrar</button>
            </div>
          </div>

          <div class="kpi kpi-2">
            <div>
              <div class="muted">OT de hoy</div>
              <div id="kpiToday" class="kpi-value">0 / 0</div>
            </div>
            <div class="pill" id="pillOffline">Offline OK</div>
          </div>
        </div>

        <div class="card glass">
          <h2>Acciones r√°pidas</h2>
          <div class="actions">
            <button id="btnScan" class="btn btn-primary">üì∑ Escanear QR</button>
            <button id="btnAddCode" class="btn">‚ûï A√±adir punto</button>
            <button id="btnMonthly" class="btn btn-ghost">üß™ Informe mensual</button>
            <button id="btnHistory" class="btn btn-ghost">üïò Historial</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button id="btnExplainOT" class="btn btn-ghost">‚ÑπÔ∏è ¬øQu√© es OT de hoy?</button>
            <button id="btnClearOT" class="btn btn-danger">üóëÔ∏è Vaciar OT</button>
          </div>

          <p class="muted tiny">Tip: crea la lista en el taller (a√±adiendo puntos) y luego solo vas cerrando en campo.</p>
        </div>

        <div class="card glass">
          <h2>OT de hoy</h2>
          <div id="otList" class="list"></div>
          <div id="otEmpty" class="empty muted">A√∫n no hay puntos. A√±ade con QR o con el c√≥digo (√∫ltimos 5).</div>
        </div>
      </div>
    </section>

    <!-- Scan -->
    <section id="screenScan" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <h2 id="scanTitle">Escanear QR</h2>
          <button class="btn btn-ghost" data-nav="home">‚úñ</button>
        </div>

        <div class="muted tiny" id="scanHint">Si tu m√≥vil no soporta escaneo nativo, usa ‚ÄúA√±adir punto‚Äù.</div>

        <div class="scanbox">
          <video id="qrVideo" playsinline></video>
          <div class="scan-overlay"></div>
        </div>

        <div class="row">
          <button id="btnStartScan" class="btn btn-primary">Iniciar c√°mara</button>
          <button id="btnStopScan" class="btn btn-ghost">Detener</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <input id="manualCodeFromScan" class="input" placeholder="O escribe c√≥digo (se usan los 5 √∫ltimos)" />
          <button id="btnManualGo" class="btn">A√±adir</button>
        </div>
      </div>
    </section>

    <!-- Punto -->
    <section id="screenPoint" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <div>
            <div class="muted">Ubicaci√≥n</div>
            <div id="pointCode" class="bigcode">‚Äî</div>
          </div>
          <div class="row">
            <button id="btnEditCode" class="btn btn-ghost" title="Editar c√≥digo">‚úèÔ∏è Editar</button>
            <button class="btn btn-ghost" data-nav="home">‚¨Ö</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="panel glass-lite">
            <h3>Calculadora</h3>

            <label class="label">Litros de agua</label>
            <div class="row">
              <input id="liters" class="input" type="number" inputmode="decimal" min="0" step="1" placeholder="Ej: 60" />
              <button id="btnUseDefaultLiters" class="btn btn-ghost">Habitual</button>
            </div>

            <div class="muted tiny">Valores prefijados (provisionales) hasta confirmar protocolo real.</div>

            <div class="divider thin"></div>

            <div class="calc-result">
              <div class="muted">Dosis estimada (ml)</div>
              <div id="doseMl" class="dose">‚Äî</div>
              <div class="muted tiny">Queda registrada al finalizar.</div>
            </div>

            <div class="divider thin"></div>

            <label class="label">Tiempo objetivo</label>
            <div class="row">
              <input id="targetMinutes" class="input" type="number" min="1" step="1" />
              <button id="btnTimeAuto" class="btn btn-ghost">Auto</button>
            </div>

            <label class="label">Observaci√≥n (opcional)</label>
            <textarea id="pointNote" class="input textarea" rows="3" placeholder="Ej: ba√±o sin retorno / puerta cerrada / pendiente..." ></textarea>

            <div class="row">
              <button id="btnSaveNote" class="btn btn-ghost">üíæ Guardar nota</button>
              <button id="btnStartTimer" class="btn btn-primary">‚è± Iniciar proceso</button>
              <button id="btnMarkIssue" class="btn btn-danger">‚ö† Incidencia</button>
            </div>
          </div>

          <div class="panel glass-lite">
            <h3>Checklist</h3>
            <div class="checklist">
              <label><input type="checkbox" id="chkConnect" /> Conectar recirculaci√≥n</label>
              <label><input type="checkbox" id="chkReturn" /> Verificar retorno</label>
              <label><input type="checkbox" id="chkDose" /> A√±adir dosis</label>
              <label><input type="checkbox" id="chkStart" /> Iniciar recirculaci√≥n</label>
            </div>

            <div class="divider thin"></div>

            <div class="muted tiny">Al finalizar saldr√° el sello ‚úÖ y quedar√° registrado en el historial con fecha/hora.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Timer -->
    <section id="screenTimer" class="screen hidden">
      <div class="card glass center">
        <div class="row space-between">
          <div>
            <div class="muted">En proceso</div>
            <div id="timerCode" class="bigcode">‚Äî</div>
          </div>
          <button class="btn btn-ghost" id="btnExitTimer">‚úñ</button>
        </div>

        <div class="timer-tank">
          <div class="ring" id="ring"></div>
          <div class="bubbles" id="bubbles"></div>
          <div class="water" id="waterFill"></div>
          <div class="tank-glass"></div>
          <div class="timer-overlay">
            <div id="timerLeft" class="timer-left">00:00</div>
            <div class="muted tiny" id="timerTarget">Objetivo: ‚Äî</div>
          </div>
        </div>

        <div class="row center">
          <button id="btnPause" class="btn btn-ghost">‚è∏ Pausar</button>
          <button id="btnResume" class="btn btn-ghost hidden">‚ñ∂ Reanudar</button>
          <button id="btnFinish" class="btn btn-primary">‚úÖ Finalizar</button>
        </div>

        <div class="divider"></div>
        <div id="sealDone" class="seal hidden">‚úî TRATAMIENTO COMPLETADO</div>
        <div id="sealWarn" class="seal seal-warn hidden">‚ö† MARCADO CON INCIDENCIA</div>
      </div>
    </section>

    <!-- Historial -->
    <section id="screenHistory" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <h2>Historial</h2>
          <button class="btn btn-ghost" data-nav="home">‚¨Ö</button>
        </div>

        <div class="row">
          <button id="btnExport" class="btn">&#x1F4E4; Exportar JSON</button>
          <button id="btnImport" class="btn btn-ghost">&#x1F4E5; Importar</button>
          <button id="btnExportExcel" class="btn btn-ghost">&#x1F4C5; Excel</button>
          <input id="fileImport" type="file" accept="application/json" class="hidden" />
        </div>

        <div class="divider"></div>

        <div id="historyList" class="list"></div>
        <div id="historyEmpty" class="empty muted">Sin registros a√∫n.</div>
      </div>
    </section>

    <!-- Mensual PRO -->
    <section id="screenMonthly" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <h2>Informe mensual ¬∑ Muestras (PRO)</h2>
          <button class="btn btn-ghost" data-nav="home">‚¨Ö</button>
        </div>

        <div class="muted tiny">
          Crea la ruta del mes por plantas (-1, Baja, 1¬™‚Äì8¬™). Exterior/Parking normalmente: <b>NO APLICA</b>.
          Los datos quedan en este m√≥vil.
        </div>

        <div class="divider"></div>

        <div class="kpi kpi-2">
          <div>
            <div class="muted">Mes</div>
            <div id="kpiMonth" class="kpi-value">‚Äî</div>
          </div>
          <div>
            <div class="muted">Progreso</div>
            <div id="kpiMonthDone" class="kpi-value">0 / 0</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="panel glass-lite">
            <h3>Cabecera</h3>
            <label class="label">Fecha muestreo</label>
            <input id="monthSampleDate" class="input" type="date" />
            <label class="label">T√©cnico asignado (acompa√±a)</label>
            <input id="monthAssignedTech" class="input" placeholder="Ej: Paco" maxlength="18" />
            <label class="label">Observaci√≥n general (opcional)</label>
            <textarea id="monthHeaderNote" class="input textarea" rows="2" placeholder="Ej: ruta parcial / cambios..." ></textarea>
            <div class="row">
              <button id="btnSaveMonthlyHeader" class="btn btn-primary">Guardar cabecera</button>
              <button id="btnMonthlyExport" class="btn">üì§ Exportar mensual</button>
            </div>
          </div>

          <div class="panel glass-lite">
            <h3>Documento (referencia)</h3>
            <div class="row">
              <button id="btnMonthlyAttach" class="btn">üìé Adjuntar PDF/Excel</button>
              <button id="btnMonthlyOpen" class="btn btn-ghost">üìÑ Abrir adjunto</button>
              <input id="monthlyFile" type="file" accept="application/pdf,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" class="hidden" />
            </div>

            <div class="divider thin"></div>

            <h3>Crear ruta</h3>
            <label class="label">Planta por defecto</label>
            <select id="monthlyPlantDefault" class="input">
              <option value="Baja">Baja</option>
              <option value="1¬™">1¬™</option><option value="2¬™">2¬™</option><option value="3¬™">3¬™</option><option value="4¬™">4¬™</option>
              <option value="5¬™">5¬™</option><option value="6¬™">6¬™</option><option value="7¬™">7¬™</option><option value="8¬™">8¬™</option>
              <option value="-1">-1</option>
              <option value="Otros">Otros</option>
            </select>

            <div class="actions">
              <button id="btnMonthlyScanHot" class="btn btn-primary">üî• Escanear ACS</button>
              <button id="btnMonthlyScanCold" class="btn btn-primary">‚ùÑÔ∏è Escanear AFCH</button>
              <button id="btnMonthlyAdd" class="btn">‚ûï A√±adir punto</button>
              <button id="btnMonthlyShowEmpty" class="btn btn-ghost">üëÅÔ∏è Mostrar vac√≠as: OFF</button>
              <button id="btnMonthlyClear" class="btn btn-danger">üóëÔ∏è Vaciar mensual</button>
            </div>

            <div class="divider thin"></div>
            <div class="muted tiny">
              Importaci√≥n autom√°tica desde Excel/PDF: preparada para la siguiente iteraci√≥n. De momento, la creaci√≥n es ultrarr√°pida con escaneo o ‚ÄúA√±adir punto‚Äù.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <span class="badge todo">‚è≥ Pendiente</span>
          <span class="badge ok">‚úÖ Hecho</span>
          <span class="badge issue">‚ö† Incid.</span>
          <span class="badge na">üö´ No aplica</span>
        </div>

        <div class="divider"></div>

        <div id="monthlyAccordions" class="accordions"></div>
        <div id="monthlyEmpty" class="empty muted">A√∫n no hay puntos mensuales.</div>
      </div>
    </section>

    <!-- Gu√≠a -->
    <section id="screenGuide" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <h2>Gu√≠a r√°pida (audio)</h2>
          <button class="btn btn-ghost" data-nav="home">‚¨Ö</button>
        </div>

        <p class="muted">Pulsa ‚ÄúReproducir‚Äù y el m√≥vil te lo leer√° en voz alta (sin internet). Puedes editar el texto.</p>

        <div class="divider"></div>

        <section class="podcast-card glass">
  <div class="podcast-head">
    <div class="podcast-cover" aria-hidden="true">
      <div class="drop"></div>
      <div class="drop d2"></div>
      <div class="drop d3"></div>
      <div class="cover-title">LEGIONELLA</div>
      <div class="cover-sub">Formaci√≥n r√°pida</div>
    </div>
    <div class="podcast-meta">
      <div class="podcast-title">Legionella y el riesgo de los aerosoles</div>
      <div class="podcast-desc muted tiny">Podcast integrado en IsiVolt Pro ¬∑ Contin√∫a donde lo dejaste.</div>
      <div class="podcast-actions">
        <button id="btnPodcastPlay" class="btn btn-primary">&#x25B6; Reproducir</button>
        <button id="btnPodcastPause" class="btn btn-ghost">&#x23F8; Pausar</button>
        <button id="btnPodcastRestart" class="btn btn-ghost">&#x21BA; Reiniciar</button>
        <button id="podcastSpeedBtn" class="btn btn-ghost">1&#xD7;</button>
      </div>
    </div>
  </div>

  <div class="podcast-wave">
    <canvas id="ropeWave" width="800" height="160" aria-hidden="true"></canvas>
  </div>

  <audio id="podcastPlayer" preload="metadata" class="podcast-native" crossorigin="anonymous">
    Tu navegador no soporta audio.
  </audio>

  <div class="podcast-progress tiny muted" id="podcastProgress">00:00 / 00:00 ¬∑ 1√ó</div>
</section>

<div class="wavebox">
          <div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div>
        </div>

        <div class="row center">
          <button id="btnSpeak" class="btn btn-primary">‚ñ∂ Reproducir</button>
          <button id="btnStopSpeak" class="btn btn-ghost">‚èπ Parar</button>
        </div>

        <div class="divider"></div>

        <textarea id="guideText" class="input textarea" rows="10"></textarea>
      </div>
    </section>

    <!-- Ajustes -->
    <div id="modalSettings" class="modal hidden">
      <div class="modal-card glass">
        <div class="row space-between">
          <h2>Ajustes (V1.3)</h2>
          <button id="btnCloseSettings" class="btn btn-ghost">‚úñ</button>
        </div>

        <div class="grid2">
          <div class="panel glass-lite">
            <h3>Lej√≠a / dosis (provisional)</h3>
            <label class="label">% lej√≠a (cloro activo aprox.)</label>
            <input id="bleachPct" class="input" type="number" min="1" max="12" step="0.5" />
            <label class="label">Objetivo ppm (mg/L)</label>
            <input id="targetPpm" class="input" type="number" min="1" step="1" />
          </div>

          <div class="panel glass-lite">
            <h3>Tiempos</h3>
            <label class="label">Tiempo base (min)</label>
            <input id="baseMin" class="input" type="number" min="1" step="1" />
            <label class="label">Factor por litro (min/L)</label>
            <input id="factorPerL" class="input" type="number" min="0" step="0.01" />
            <div class="muted tiny">Auto = base + (L √ó factor). Si factor=0, queda fijo.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnSaveSettings" class="btn btn-primary">Guardar</button>
          <button id="btnResetSettings" class="btn btn-danger">Restablecer</button>
          <button id="btnChangePass" class="btn btn-ghost">&#x1F511; Cambiar acceso</button>
        </div>
      </div>
    </div>

  <section class="card" id="monthlyCard">
  <div class="card-head">
    <div class="card-title">
      <h3>Informe mensual</h3>
      <p class="muted">Pega el listado (uno por l√≠nea) o sube CSV. Se agrupa por Planta y MacroZona.</p>
    </div>
  </div>
  <div class="grid-2">
    <textarea id="monthlyImportText" class="input" rows="6" placeholder="Ej:
2D071 Ducha ACS
21001 Grifo AFCH
SA001 Aljibe
..."></textarea>
    <div class="stack">
      <input type="file" id="monthlyImportFile" class="input" accept=".csv,text/csv" />
      <button class="btn primary" id="monthlyBuildBtn">Generar checklist</button>
      <button class="btn" id="monthlyClearBtn">Vaciar mensual</button>
      <div class="muted tiny">Tip: detecta el c√≥digo aunque la l√≠nea tenga m√°s texto.</div>
    </div>
  </div>
  <div id="monthlyList" class="monthly-list"></div>
</section>
</main>

    <!-- Toasts -->
    <div id="toastRoot" class="toast-root"></div>

    <!-- Update available -->
    <div id="updateBanner" class="update-banner hidden">
      <div class="update-card glass">
        <div class="update-title">‚ö° Nueva versi√≥n disponible</div>
        <div class="muted tiny">Pulsa actualizar para cargar la √∫ltima versi√≥n.</div>
        <div class="row">
          <button id="btnUpdateNow" class="btn btn-primary">Actualizar</button>
          <button id="btnUpdateLater" class="btn btn-ghost">Luego</button>
        </div>
      </div>
    </div>

  <script type="module" src="app.js"></script>
<!-- Mini Player -->
<div id="miniPlayer" class="mini-player hidden">
  <div class="mini-glass">
    <div class="mini-left">
      <div class="mini-dot"></div>
      <div class="mini-title">Podcast</div>
      <div class="mini-time" id="miniTime">00:00 / 00:00</div>
    </div>
    <div class="mini-controls">
      <button id="miniRew" class="mini-btn" title="-10s">‚ü≤10</button>
      <button id="miniPlay" class="mini-btn primary" title="Play/Pause">‚ñ∂</button>
      <button id="miniFwd" class="mini-btn" title="+10s">10‚ü≥</button>
    </div>
  </div>
  <div class="mini-bar"><div id="miniBarFill"></div></div>
</div>
</body>
</html>
